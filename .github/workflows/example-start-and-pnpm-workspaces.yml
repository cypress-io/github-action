name: example-start-and-pnpm-workspaces
# In the example jobs, the action is called with
# uses: ./
# which runs the action code from the current branch.
# If you copy this workflow to another repo, replace the line with
# uses: cypress-io/github-action@v7
on:
  push:
    branches:
      - 'master'
  pull_request:
  workflow_dispatch:

jobs:
  # The example has pnpm workspaces in its "root" folder
  # examples/start-and-pnpm-workspaces

  single-ws:
    # This job installs pnpm,
    # installs all dependencies,
    # then runs Cypress tests in the single workspace
    # of the subfolder "packages/workspace-1".
    runs-on: ubuntu-24.04
    name: Single workspace
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

        # See https://github.com/pnpm/action-setup
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

        # See https://github.com/actions/setup-node
      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: pnpm
          cache-dependency-path: examples/start-and-pnpm-workspaces/pnpm-lock.yaml

      - name: Install dependencies
        # All dependencies including workspaces are installed
        uses: ./
        with:
          package-manager-cache: false
          runTests: false
          working-directory: examples/start-and-pnpm-workspaces

      - name: Cypress test Single
        # Run Cypress in examples/start-and-pnpm-workspaces/packages/workspace-1 only
        uses: ./
        with:
          # Do not attempt to install dependencies in the workspace using the action.
          # There is no pnpm-lock.yaml file in a workspace for
          # Cypress GitHub Action to use.
          # We already installed dependencies previously.
          install: false
          working-directory: examples/start-and-pnpm-workspaces/packages/workspace-1
          build: pnpm run build
          start: pnpm start
          wait-on: 'http://localhost:5000'

  multiple-ws:
    # This job installs pnpm,
    # installs all dependencies,
    # then runs Cypress tests in each of the workspaces.
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        cypress:
          - working_directory: examples/start-and-pnpm-workspaces/packages/workspace-1
          - working_directory: examples/start-and-pnpm-workspaces/packages/workspace-2
    name: Multiple workspaces
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: pnpm
          cache-dependency-path: examples/start-and-pnpm-workspaces/pnpm-lock.yaml

      - name: Install dependencies
        uses: ./
        with:
          package-manager-cache: false
          runTests: false
          working-directory: examples/start-and-pnpm-workspaces

      - name: Cypress test Multiple
        # Run Cypress in
        # examples/start-and-pnpm-workspaces/packages/workspace-1 and
        # examples/start-and-pnpm-workspaces/packages/workspace-2
        uses: ./
        with:
          install: false
          working-directory: ${{ matrix.cypress.working_directory }}
          build: pnpm run build
          start: pnpm start
          wait-on: 'http://localhost:5000'
